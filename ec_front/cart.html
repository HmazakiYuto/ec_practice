<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>カート</title>
</head>
<body>
    <div><a href="/html/ec2_practice.html" class="return_home btn btn-link mt-3 ms-3">ホームに戻る</a></div>
<div class="container mt-5">
  <h2>カート</h2>
  <div id="cart-items"></div>
  <hr>
  <div id="cart-total" class="fs-5 fw-bold"></div>
</div>

<script>
function loadCart() {
  const cartContainer = document.getElementById('cart-items');
  cartContainer.innerHTML = '';
  let total = 0;

  // LocalStorage から cart_ で始まるアイテムを取得
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (!key.startsWith('cart_')) continue;

    const itemId = key.replace('cart_', '');
    const quantity = parseInt(localStorage.getItem(key));
    const item = JSON.parse(localStorage.getItem('item_' + itemId));

    if (!item || quantity === 0) continue;

    const subtotal = quantity * item.item_price;
    total += subtotal;

    const itemCard = document.createElement('div');
    itemCard.className = 'card mb-2 p-2';
    itemCard.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>${item.item_name}</strong><br>
          価格: ¥${item.item_price} × ${quantity} = ¥${subtotal}<br>
          在庫: ${item.item_stock}
        </div>
        <div class="btn-group">
          <button class="btn btn-sm btn-secondary decrease-btn" data-id="${itemId}">−</button>
          <button class="btn btn-sm btn-secondary increase-btn" data-id="${itemId}">＋</button>
          <button class="btn btn-sm btn-danger remove-btn" data-id="${itemId}">削除</button>
        </div>
      </div>
    `;
    cartContainer.appendChild(itemCard);
  }

  document.getElementById('cart-total').textContent = `合計: ¥${total}`;

  // ボタンイベント登録
  document.querySelectorAll('.increase-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const cartKey = 'cart_' + id;
      const item = JSON.parse(localStorage.getItem('item_' + id));
      let quantity = parseInt(localStorage.getItem(cartKey)) || 0;

      if (quantity + 1 > item.item_stock) {
        alert('これ以上追加できません');
        return;
      }
      quantity += 1;
      localStorage.setItem(cartKey, quantity);
      loadCart();
    });
  });

  document.querySelectorAll('.decrease-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const cartKey = 'cart_' + id;
      let quantity = parseInt(localStorage.getItem(cartKey)) || 0;
      if (quantity <= 1) {
        // 1以下なら削除
        localStorage.removeItem(cartKey);
      } else {
        quantity -= 1;
        localStorage.setItem(cartKey, quantity);
      }
      loadCart();
    });
  });

  document.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      localStorage.removeItem('cart_' + id);
      loadCart();
    });
  });
}

document.addEventListener('DOMContentLoaded', loadCart);
</script>
</body>
</html>
